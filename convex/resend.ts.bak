"use node";

import { Resend } from "resend";
import { redactApiKey } from "./lib/utils";
import { APIError } from "./lib/errors";
import { createDecipheriv } from "crypto";

const ALGORITHM = "aes-256-gcm";
const ENCRYPTION_KEY = process.env.ENCRYPTION_KEY!; // 32 bytes

function decrypt(encryptedData: string): string {
  const parts = encryptedData.split(":");
  const iv = Buffer.from(parts[0], "hex");
  const authTag = Buffer.from(parts[1], "hex");
  const encrypted = parts[2];

  const decipher = createDecipheriv(ALGORITHM, Buffer.from(ENCRYPTION_KEY, "hex"), iv);
  decipher.setAuthTag(authTag);

  let decrypted = decipher.update(encrypted, "hex", "utf8");
  decrypted += decipher.final("utf8");

  return decrypted;
}

export function getResendKey(
  account: any,
  headerOverride?: string | null
): string {
  // Header override takes precedence (PRD Section 8)
  if (headerOverride) {
    return headerOverride;
  }

  if (!account.resend_api_key_encrypted) {
    throw new APIError(
      "invalid_api_key",
      "No Resend API key configured for this account",
      { account_id: account._id },
      400
    );
  }

  return decrypt(account.resend_api_key_encrypted);
}

export async function validateResendKey(apiKey: string): Promise<boolean> {
  try {
    const resend = new Resend(apiKey);

    // Test API key by fetching domains (lightweight validation)
    await resend.domains.list();

    return true;
  } catch (error: any) {
    if (error.message?.includes("401") || error.message?.includes("Invalid")) {
      throw new APIError(
        "resend_auth_failed",
        "The provided Resend API key is invalid",
        { key_suffix: redactApiKey(apiKey) },
        401
      );
    }
    throw error;
  }
}

export function createResendClient(apiKey: string): Resend {
  return new Resend(apiKey);
}

export async function getResendClientFromRequest(
  account: any,
  request: Request
): Promise<Resend> {
  const headerKey = request.headers.get("X-Resend-Key");
  const apiKey = getResendKey(account, headerKey);

  // Validate on first use
  await validateResendKey(apiKey);

  return createResendClient(apiKey);
}
